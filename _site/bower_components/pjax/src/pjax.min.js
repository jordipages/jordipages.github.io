!function(t,e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define([],e):t.Pjax=e()}(this,function(){"use strict";function t(){return(new Date).getTime()}var e=function(o){this.firstrun=!0,this.options=o,this.options.elements=this.options.elements||"a[href], form[action]",this.options.selectors=this.options.selectors||["title",".js-Pjax"],this.options.switches=this.options.switches||{},this.options.switchesOptions=this.options.switchesOptions||{},this.options.history=this.options.history||!0,this.options.currentUrlFullReload=this.options.currentUrlFullReload||!1,this.options.analytics=this.options.analytics||function(t){window._gaq&&_gaq.push(["_trackPageview"]),window.ga&&ga("send","pageview",{page:t.url,title:t.title})},this.options.scrollTo=this.options.scrollTo||0,this.options.debug=this.options.debug||!1,this.maxUid=this.lastUid=t(),this.options.switches.head||(this.options.switches.head=this.switchElementsAlt),this.options.switches.body||(this.options.switches.body=this.switchElementsAlt),this.log("Pjax options",this.options),"function"!=typeof o.analytics&&(o.analytics=function(){}),this.parseDOM(document),e.on(window,"popstate",function(t){if(t.state){var o=e.clone(this.options);o.url=t.state.url,o.title=t.state.title,o.history=!1,t.state.uid<this.lastUid?o.backward=!0:o.forward=!0,this.lastUid=t.state.uid,this.loadUrl(t.state.url,o)}}.bind(this))};if(e.isSupported=function(){return window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]\D|WebApps\/.+CFNetwork)/)},e.forEachEls=function(t,e,o){return t instanceof HTMLCollection||t instanceof NodeList?Array.prototype.forEach.call(t,e,o):void e.call(o,t)},e.on=function(t,o,s,n){o="string"==typeof o?o.split(" "):o,o.forEach(function(o){e.forEachEls(t,function(t){t.addEventListener(o,s,n)})},this)},e.off=function(t,o,s,n){o="string"==typeof o?o.split(" "):o,o.forEach(function(o){e.forEachEls(t,function(t){t.removeEventListener(o,s,n)})},this)},e.trigger=function(t,o){o="string"==typeof o?o.split(" "):o,o.forEach(function(o){var s;document.createEvent?(s=document.createEvent("HTMLEvents"),s.initEvent(o,!0,!0)):(s=document.createEventObject(),s.eventType=o),s.eventName=o,document.createEvent?e.forEachEls(t,function(t){t.dispatchEvent(s)}):e.forEachEls(t,function(t){t.fireEvent("on"+s.eventType,s)})},this)},e.clone=function(t){if(null===t||"object"!=typeof t)return t;var e=t.constructor();for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);return e},e.executeScripts=function(t){e.forEachEls(t.querySelectorAll("script"),function(t){t.type&&"text/javascript"!==t.type.toLowerCase()||(t.parentNode&&t.parentNode.removeChild(t),e.evalScript(t))})},e.evalScript=function(t){var e=t.text||t.textContent||t.innerHTML||"",o=document.querySelector("head")||document.documentElement,s=document.createElement("script");if(e.match("document.write"))return console&&console.log&&console.log("Script contains document.write. Can’t be executed correctly. Code skipped ",t),!1;s.type="text/javascript";try{s.appendChild(document.createTextNode(e))}catch(n){s.text=e}return o.insertBefore(s,o.firstChild),o.removeChild(s),!0},e.prototype={log:function(){this.options.debug&&console&&("function"==typeof console.log?console.log.apply(console,arguments):console.log&&console.log(arguments))},getElements:function(t){return t.querySelectorAll(this.options.elements)},parseDOM:function(t){e.forEachEls(this.getElements(t),function(t){switch(t.tagName.toLowerCase()){case"a":this.attachLink(t);break;case"form":this.log("Pjax doesnt support <form> yet. TODO :)");break;default:throw"Pjax can only be applied on <a> or <form> submit"}},this)},attachLink:function(t){e.on(t,"click",function(o){return o.which>1||o.metaKey||o.ctrlKey||o.shiftKey||o.altKey?-1:t.protocol!==window.location.protocol||t.host!==window.location.host?-2:t.pathname===location.pathname&&t.hash.length>0?-3:t.hash&&t.href.replace(t.hash,"")===location.href.replace(location.hash,"")?-4:t.href===location.href+"#"?-5:(o.preventDefault(),this.options.currentUrlFullReload&&t.href===window.location.href?(window.location.reload(),-6):void this.loadUrl(t.href,e.clone(this.options)))}.bind(this)),e.on(t,"keyup",function(){this.log("pjax todo")}.bind(this))},forEachSelectors:function(t,o,s){s=s||document,this.options.selectors.forEach(function(n){e.forEachEls(s.querySelectorAll(n),t,o)})},switchSelectors:function(t,o,s,n){t.forEach(function(t){var i=o.querySelectorAll(t),a=s.querySelectorAll(t);if(this.log("Pjax switch",t,i,a),i.length!==a.length)throw"DOM doesn’t look the same on new loaded page: ’"+t+"’ - new "+i.length+", old "+a.length;e.forEachEls(i,function(o,s){var i=a[s];this.log("newEl",o,"oldEl",i),this.options.switches[t]?this.options.switches[t].bind(this)(i,o,n,this.options.switchesOptions[t]):e.switches.outerHTML.bind(this)(i,o,n)},this)},this)},latestChance:function(t){window.location=t},onSwitch:function(){e.trigger(window,"resize scroll")},loadContent:function(t,o){var s=document.implementation.createHTMLDocument(""),n=/<html[^>]+>/gi,i=/\s?[a-z:]+(?:\=(?:\'|\")[^\'\">]+(?:\'|\"))*/gi,a=t.match(n);a&&a.length&&(a=a[0].match(i),a.length&&(a.shift(),a.forEach(function(t){var e=t.trim().split("=");s.documentElement.setAttribute(e[0],e[1].slice(1,-1))}))),s.documentElement.innerHTML=t,this.log("load content",s.documentElement.attributes,s.documentElement.innerHTML.length),this.switchSelectors(this.options.selectors,s,document,o);var c=Array.prototype.slice.call(document.querySelectorAll("[autofocus]")).pop();c&&document.activeElement!==c&&c.focus(),this.options.selectors.forEach(function(t){e.forEachEls(document.querySelectorAll(t),function(t){e.executeScripts(t)})})},doRequest:function(t,e){var o=new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState&&200===o.status?e(o.responseText):4!==o.readyState||404!==o.status&&500!==o.status||e(!1)},o.open("GET",t+(/[?&]/.test(t)?"&":"?")+(new Date).getTime(),!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.send(null)},loadUrl:function(o,s){this.log("load href",o,s),e.trigger(document,"pjax:send",s),this.doRequest(o,function(n){if(n===!1)return void e.trigger(document,"pjax:complete pjax:error",s);document.activeElement.blur();try{this.loadContent(n,s)}catch(i){if(this.options.debug)throw i;return console&&console.error&&console.error("Pjax switch fail: ",i),void this.latestChance(o)}s.history&&(this.firstrun&&(this.lastUid=this.maxUid=t(),this.firstrun=!1,window.history.replaceState({url:window.location.href,title:document.title,uid:this.maxUid},document.title)),this.lastUid=this.maxUid=t(),window.history.pushState({url:o,title:s.title,uid:this.maxUid},s.title,o)),this.forEachSelectors(function(t){this.parseDOM(t)},this),e.trigger(document,"pjax:complete pjax:success",s),s.analytics(),s.scrollTo!==!1&&(s.scrollTo.length>1?window.scrollTo(s.scrollTo[0],s.scrollTo[1]):window.scrollTo(0,s.scrollTo))}.bind(this))}},e.switches={outerHTML:function(t,e){t.outerHTML=e.outerHTML,this.onSwitch()},innerHTML:function(t,e){t.innerHTML=e.innerHTML,t.className=e.className,this.onSwitch()},sideBySide:function(t,o,s,n){var i=Array.prototype.forEach,a=[],c=[],r=document.createDocumentFragment(),l="animationend webkitAnimationEnd MSAnimationEnd oanimationend",h=0,u=function(t){t.target==t.currentTarget&&(h--,0>=h&&a&&(a.forEach(function(t){t.parentNode&&t.parentNode.removeChild(t)}),c.forEach(function(t){t.className=t.className.replace(t.getAttribute("data-pjax-classes"),""),t.removeAttribute("data-pjax-classes")}),c=null,a=null,this.onSwitch()))}.bind(this);n=n||{},i.call(t.childNodes,function(t){a.push(t),t.classList&&!t.classList.contains("js-Pjax-remove")&&(t.hasAttribute("data-pjax-classes")&&(t.className=t.className.replace(t.getAttribute("data-pjax-classes"),""),t.removeAttribute("data-pjax-classes")),t.classList.add("js-Pjax-remove"),n.callbacks&&n.callbacks.removeElement&&n.callbacks.removeElement(t),n.classNames&&(t.className+=" "+n.classNames.remove+" "+(s.backward?n.classNames.backward:n.classNames.forward)),h++,e.on(t,l,u,!0))}),i.call(o.childNodes,function(t){if(t.classList){var o="";n.classNames&&(o=" js-Pjax-add "+n.classNames.add+" "+(s.backward?n.classNames.forward:n.classNames.backward)),n.callbacks&&n.callbacks.addElement&&n.callbacks.addElement(t),t.className+=o,t.setAttribute("data-pjax-classes",o),c.push(t),r.appendChild(t),h++,e.on(t,l,u,!0)}}),t.className=o.className,t.appendChild(r)}},e.isSupported())return e;var o=function(){};for(var s in e.prototype)e.prototype.hasOwnProperty(s)&&"function"==typeof e.prototype[s]&&(o[s]=o);return o});